@page
@model QLNVSSV.WebApp.Pages.EmployeeModel
@{
}

<style>
    .loadding {
        position: fixed;
        top: 0;
        width: 50px;
        top: 50%;
        left: 50%;
        z-index: 999;
    }

    .fullscreen {
        background: #ccc;
        position: fixed;
        top: 0;
        left: 0;
        bottom: 0;
        right: 0;
        opacity: 0.3;
        z-index: 999;
    }
</style>

<button onclick="create()" type="button" class="btn btn-outline-primary">Thêm Mới</button>
<table style="margin-top:20px" class="table">
    <thead>
        <tr>

            <th scope="col">ID</th>
            <th scope="col">Tên chức vụ</th>
            <th scope="col">Tên vị trí</th>
            <th scope="col">Tên NV</th>
            <th scope="col">Ngày sinh</th>
            <th scope="col">Địa chỉ</th>
            <th scope="col">Email</th>
            <th scope="col">CV</th>
            <th scope="col">Người Giới thiệu</th>
            <th scope="col">Hành động</th>
        </tr>
    </thead>
    <tbody id="tablebody">
    </tbody>


</table>

<nav aria-label="...">
    <ul class="pagination">
        <li class="page-item disabled">
            <span class="page-link">Previous</span>
        </li>
        <li class="page-item"><a class="page-link" href="#">1</a></li>
        <li class="page-item"><a class="page-link" href="#">2</a></li>
        <li class="page-item"><a class="page-link" href="#">3</a></li>
        <li class="page-item active">
            <span class="page-link">
                4
                <span class="sr-only">(current)</span>
            </span>
        </li>
        <li class="page-item"><a class="page-link" href="#">5</a></li>
        <li class="page-item"><a class="page-link" href="#">6</a></li>
        <li id="pagelast" class="page-item"><a class="page-link" href="#">7</a></li>
        <li class="page-item">
            <a class="page-link" href="#">Next</a>
        </li>
    </ul>
</nav>


<div id="fullscreen" class="fullscreen"></div>
<img id="loadding" class="loadding" src="~/Img/cupertino_activity_indicator.gif" />
<div class="modal fade" id="exampleModalCenter" tabindex="-1" role="dialog" aria-labelledby="exampleModalCenterTitle" aria-hidden="true">
    <div style="max-width:50% !important" class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="exampleModalLongTitle">Modal title</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">

                <div class="form-row">
                    <div class="form-group col-md-6">
                        <label for="exampleInputEmail1">Chức vụ</label>
                        <select id="cb_position" class="form-control form-select" aria-label="Default select example">
                        </select>
                    </div>

                    <div class="form-group col-md-6">
                        <label for="exampleInputEmail1">Vị trí</label>
                        <select id="cb_title" class="form-control form-select" aria-label="Default select example">
                        </select>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group col-md-6">
                        <label for="exampleInputEmail1">Tên NV</label>
                        <input id="txt_name" name="namee" type="text" class="form-control" aria-describedby="emailHelp" placeholder="Enter email">
                    </div>
                    <div class="form-group col-md-6">
                        <label for="exampleInputEmail1">Địa chỉ</label>
                        <input id="txt_address" name="address" type="text" class="form-control" aria-describedby="emailHelp" placeholder="Enter email">
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group col-md-6">
                        <label for="exampleInputEmail1">Email</label>
                        <input id="txt_email" name="email" type="email" class="form-control" aria-describedby="emailHelp" placeholder="Enter email">
                    </div>
                    <div class="form-group col-md-6">
                        <label for="exampleInputEmail1">CV</label>
                        <input id="ip_file" type="file" name="file" />
                        <label id="lb_file"></label>
                    </div>
                </div>

            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                <button id="SaveButton" type="button" class="btn btn-primary">Cập Nhật</button>
            </div>

        </div>
    </div>
</div>

<script src="~/js/common.js"></script>
<script>



    var position = document.getElementById('cb_position');
    var title = document.getElementById('cb_title');

    var arr_position = [];
    var arr_title = [];


    var full = document.getElementById('fullscreen');
    var load = document.getElementById('loadding');

    //input form

    var idtarget;


    function LoadEmployee(pageindex) {

        pageTarget = pageindex
        var url = 'http://localhost:37919/api/Employee/Page/'+pageindex+'';
        var body = document.getElementById('tablebody');
        var html = "";
        fetch(url)
            .then(response => response.json())
            .then(data => {
                var obj = JSON.parse(JSON.stringify(data))
                for (var i = 0; i < obj.length; i++) {
                    html += `
                            <tr>
                            <th scope="row">${obj[i].employeeId}</th>
                            <td>${obj[i].titleName}</td>
                            <td>${obj[i].positionName}</td>
                            <td>${obj[i].employeeName}</td>
                            <td>${obj[i].dateOfBirth}</td>
                            <td>${obj[i].address}</td>
                            <td>${obj[i].email}</td>`

                    html += '<td><a href="http://localhost:37919/Image/' + obj[i].cv + '">' + obj[i].cv + '</a></td >';
                    html += `<td>${obj[i].presenterName}</td>
                            <td>
                                <button id="delete_${obj[i].employeeId}" onclick=Delete(${obj[i].employeeId}) type="button" class="btn btn-outline-danger">Danger</button>
                                <button  onclick="Momodal(${obj[i].employeeId})" type="button" class="btn btn-outline-primary" data-toggle="modal" data-target="#exampleModalCenter">Sửa</button>
                            </td>
                        </tr>
                    `
                }
                body.innerHTML = html;
                endLoadding();
            })
    }
    LoadEmployee(1);

    function LoadPosition() {
        var html = "";
        var url = "http://localhost:37919/api/Position/GetAll";
        fetch(url)
            .then(response => response.json())
            .then(data => {


                var obj = JSON.parse(JSON.stringify(data))
                for (var i = 0; i < obj.length; i++) {
                    html += `<option value="${obj[i].positionId}" class="position">${obj[i].positionName}</option>`;
                    arr_position.push(obj[i].positionName)
                }

                document.getElementById('cb_position').innerHTML = html
            })
    }
    LoadPosition();


    function LoadTitle() {
        var html = "";
        var url = "http://localhost:37919/api/Title/GetAll";
        fetch(url)
            .then(response => response.json())
            .then(data => {


                var obj = JSON.parse(JSON.stringify(data))
                for (var i = 0; i < obj.length; i++) {
                    html += `<option value="${obj[i].titleId}" class="title">${obj[i].titleName}</option>`;
                    arr_position.push(obj[i].positionName)
                }

                document.getElementById('cb_title').innerHTML = html
            })
    }
    LoadTitle();

    function endLoadding() {
        full.style.display = 'none'
        load.style.display = 'none'
    }

    function Momodal(id) {
        idtarget = id

        var name = document.getElementById('txt_name')
        var address = document.getElementById('txt_address')
        var email = document.getElementById('txt_email')
        var lbfile = document.getElementById('lb_file')
        var ipfile = document.getElementById('ip_file')

        var positionElement = document.getElementsByClassName('position')
        var titleElement = document.getElementsByClassName('title')
        console.log(id)


        $('#exampleModalLongTitle').html('Edit');
        $('#modalForm').modal('toggle');

        $('#SaveButton')[0].addEventListener('click', editItem);



        fetch("http://localhost:37919/api/Employee/" + id + "")
            .then(response => response.json())
            .then(data => {
                var obj = JSON.parse(JSON.stringify(data))
                setSelected(obj.positionName, positionElement)
                setSelected(obj.titleName, titleElement)
                name.value = obj.employeeName;
                address.value = obj.address;
                email.value = obj.email;
                lbfile.innerText = obj.cv;
            })
    }

    function setSelected(value, elementList) {
        for (var i = 0; i < elementList.length; i++) {
            if (elementList[i].value == value) {
                elementList[i].selected = 'selected'
            }
        }
        console.log(elementList)
    }

    function Delete(id) {
        fetch('http://localhost:37919/api/Employee/2', {
            method: 'DELETE'
        })
            .then(response => response.json())
            .then(data => {
                var btn = document.getElementById('delete_' + id + '');
                var action = btn.parentElement;
                var tr = action.parentElement;
                tr.style.display = 'none'
            })
    }

    function create() {
        console.log('a')
        $('#exampleModalLongTitle').html('Add');
        $('#modalForm').modal('toggle');
        console.log($('#SaveButton'))
        $('#exampleModalCenter').modal('show');
        $('#SaveButton')[0].addEventListener('click', createItem);


    }

    function createItem() {
        console.log('create');
    }
    function editItem() {
        var position = document.getElementById('cb_position');
        var title = document.getElementById('cb_title');
        var name = document.getElementById('txt_name')
        var address = document.getElementById('txt_address')
        var email = document.getElementById('txt_email')
        var ipfile = document.getElementById('ip_file')
        var lbfile = document.getElementById('lb_file')
        var data = {
            employeeId: idtarget,
            employeeName: name.value,
            address: address.value,
            PositionId: position.value,
            TitleId: title.value,
            cv: ipfile.value.replace(/^.*[\\\/]/, '')
        }
        console.log(data)

        fetch('http://localhost:37919/api/Employee', {
            method: 'PUT', // or 'PUT'
            headers: {
                'Accept': 'application/json',
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(data),
        })
            .then(response => response.json())
            .then(data => {
                console.log('Success:', data);
            })
            .catch((error) => {
                console.error('Error:', error);
            });



        const formData = new FormData();
        formData.append('filecv', ipfile.files[0])
        formData.append('fileNamelb', lbfile.textContent)
        console.log(formData)
        fetch('http://localhost:37919/api/File', {
            method: 'POST',
            body: formData,
            'Content-Type': `multipart/form-data`
        })
            .then(response => response.json())
            .then(data => {
                console.log(data)
            })
    }



    function LoadPaging() {
        var html = "";
        if (pageTarget == 1) {
            html += `<li id="prev" class="page-item disabled">
                                <span class="page-link">Previous</span>
                            </li>`;
        }
        else {
            html += `<li id="prev" class="page-item">
                                <span class="page-link">Previous</span>
                            </li>`;
        }

        html += `<li class="page-item"><a class="page-link" href="#">1</a></li>`;

        html += `<li id="prev1" class="page-item"><a class="page-link" href="#">${pageTarget + 1}</a></li>`
        html += `<li id="mid" class="page-item"><a class="page-link" href="#">${pageTarget + 2}</a></li>`
        html += `<li class="page-item"><a class="page-link" href="#">${pageTarget + 3}</a></li>`
        html += `<li class="page-item"><a class="page-link" href="#">${pageTarget + 4}</a></li>`


        html += `<li id="pagelast" class="page-item"><a class="page-link" href="#">${pageEnd}</a></li>`;
        if (pageTarget == pageEnd) {
            html += `<li class="page-item disabled">
                                <a class="page-link" href="#">Next</a>
                            </li>`
        }
        else {
            html += `<li class="page-item">
                                <a class="page-link" href="#">Next</a>
                            </li>`
        }
        pageElement.innerHTML = html
    }

    //paging


    var totalRecord;
    const pagesiez = 3;
    var pageEnd;
    var pageTarget = 1;
    var pageElement = document.getElementsByClassName('pagination')[0];

    function render() {
        return new Promise()
    }

    function GetcountRecord() {
        var html = '';
        fetch('http://localhost:37919/api/Employee/GetCount')
            .then(response => response.json())
            .then(data => {
                totalRecord = data.data;
                $('#pagelast').attr('href', "")
                pageEnd = Math.floor(totalRecord / pagesiez)+1



                if (pageTarget == 1) {
                    html += `<li id="prev" class="page-item disabled">
                                <span class="page-link">Previous</span>
                            </li>`;
                }
                else {
                    html += `<li id="prev" class="page-item">
                                <span class="page-link">Previous</span>
                            </li>`;
                }

                html += `<li class="page-item"><a class="page-link" href="#">1</a></li>`;

                if (pageTarget < 5 && pageEnd>5) {

                    html += `<li class="page-item"><a class="page-link" href="#">2</a></li>`;
                    html += `<li class="page-item"><a class="page-link" href="#">3</a></li>`;
                    html += `<li class="page-item"><a class="page-link" href="#">4</a></li>`;
                    html += `<li class="page-item"><a class="page-link" href="#">5</a></li>`;
                }
                else if (pageEnd < 5) {
                    for (var i = 2; i < pageEnd; i++) {
                        html += `<li class="page-item"><a class="page-link" href="#">${i}</a></li>`;
                    }
                }
                else if (pageTarget >= pageEnd - 4) {
                    html += `<li class="page-item"><a class="page-link" href="#">${pageEnd - 4}</a></li>`;
                    html += `<li class="page-item"><a class="page-link" href="#">${pageEnd - 3}</a></li>`;
                    html += `<li class="page-item"><a class="page-link" href="#">${pageEnd - 2}</a></li>`;
                    html += `<li class="page-item"><a class="page-link" href="#">${pageEnd-1}</a></li>`;
                }
                else {
                    html += `<li class="page-item"><a class="page-link" href="#">${(parseInt(pageTarget) - 2)}</a></li>`;
                    html += `<li class="page-item"><a class="page-link" href="#">${(parseInt(pageTarget) - 1)}</a></li>`;
                    html += `<li class="page-item active"><a active class="page-link" href="#">${(parseInt(pageTarget) )}</a></li>`;
                    html += `<li class="page-item"><a class="page-link" href="#">${(parseInt(pageTarget) + 1)}</a></li>`;
                    html += `<li class="page-item"><a class="page-link" href="#">${(parseInt(pageTarget) + 2)}</a></li>`;
                }


                html += `<li id="pagelast" class="page-item"><a class="page-link" href="#">${pageEnd}</a></li>`;
                if (pageTarget == pageEnd) {
                    html += `<li class="page-item disabled">
                                <a class="page-link" href="#">Next</a>
                            </li>`
                }
                else {
                    html += `<li class="page-item">
                                <a class="page-link" href="#">Next</a>
                            </li>`
                }
                pageElement.innerHTML = html
                var pageItem = document.getElementsByClassName('page-item')
                for (var i = 0; i < pageItem.length; i++) {
                    pageItem[i].classList.remove("active");
                    if (pageItem[i].textContent == pageTarget) {
                        pageItem[i].classList.add('active')
                    }
                }
                CallPageing();

            })
    }
    GetcountRecord();

    function CallPageing() {

        document.querySelectorAll('.page-item').forEach(item => {
            item.addEventListener('click', event => {
                LoadEmployee(item.textContent);
                console.log(pageTarget)
                
               
                $('#prev1').text(parseInt(parseInt(pageTarget) - 1))
                $('#mid').text(parseInt(parseInt(pageTarget)))
                $('#next1').text(parseInt(parseInt(pageTarget) + 1))
                GetcountRecord();
            })
        })
        
    }



</script>
<!--
<nav aria-label="...">
    <ul class="pagination">
        <li class="page-item disabled">
            <span class="page-link">Previous</span>
        </li>
        <li class="page-item"><a class="page-link" href="#">1</a></li>
        <li class="page-item"><a class="page-link" href="#">2</a></li>
        <li class="page-item"><a class="page-link" href="#">3</a></li>
        <li class="page-item active">
            <span class="page-link">
                4
                <span class="sr-only">(current)</span>
            </span>
        </li>
        <li class="page-item"><a class="page-link" href="#">5</a></li>
        <li class="page-item"><a class="page-link" href="#">6</a></li>
        <li id="pagelast" class="page-item"><a class="page-link" href="#">7</a></li>
        <li class="page-item">
            <a class="page-link" href="#">Next</a>
        </li>
    </ul>
</nav>
    -->
